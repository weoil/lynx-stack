import { Columns } from '@components/Columns.jsx';
import { PackageManagerTabs } from '@theme';

# å›½é™…åŒ–

**å›½é™…åŒ–**ï¼ˆInternationalizationï¼Œç®€å†™ä¸º I18nï¼‰ï¼Œæ˜¯æŒ‡åœ¨è®¾è®¡å’Œå¼€å‘äº§å“ã€åº”ç”¨ç¨‹åºæ—¶ï¼Œå¯¹å…¶è¿›è¡Œ**æœ¬åœ°åŒ–**ï¼Œä»¥é€‚åº”ä¸åŒçš„æ–‡åŒ–ã€åœ°åŒºæˆ–è¯­è¨€çš„ç›®æ ‡ç”¨æˆ·ã€‚ä½ å¯ä»¥ä½¿ç”¨ `i18next` ç­‰ i18n åº“å®ç°å›½é™…åŒ–ï¼Œä¸ºç”¨æˆ·æä¾›æ˜“äºè®¿é—®çš„ä½“éªŒã€‚

## Intl API

[`Intl`](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Intl) å¯¹è±¡æ˜¯ ECMAScript å›½é™…åŒ– API çš„ä¸€ä¸ªå‘½åç©ºé—´ï¼Œæä¾›äº†ä¸€ç»„å¤„ç†å›½é™…åŒ–ä¸æœ¬åœ°åŒ–çš„æ–¹æ³•ã€‚é€šè¿‡ `Intl` APIï¼Œèƒ½å¤Ÿå¤„ç†æ•°å­—ã€æ—¥æœŸå’Œæ—¶é—´ç­‰ç›¸å…³é—®é¢˜ï¼Œæ¯”å¦‚æ•°å­—æ ¼å¼åŒ–ã€æ—¥æœŸå’Œæ—¶é—´æ ¼å¼åŒ–ã€‚

ç›®å‰åœ¨ Lynx ä¸­ `Intl` API å°šæœªå®ç°ï¼Œå¹¶å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æ”¯æŒã€‚å¦‚æœä½ éœ€è¦ä½¿ç”¨åœ¨ Lynx ä¸­ä½¿ç”¨ `Intl` APIï¼Œä½ å¯ä»¥å®‰è£…å¯¹åº”çš„ Polyfillï¼Œä¾‹å¦‚ [@formatjs/intl-numberformat
](https://www.npmjs.com/package/@formatjs/intl-numberformat)ã€[@formatjs/intl-datetimeformat](https://www.npmjs.com/package/@formatjs/intl-datetimeformat)ã€[intl-pluralrules](https://www.npmjs.com/package/intl-pluralrules) ç­‰ã€‚

## ä½¿ç”¨ `i18next`

[`i18next`](https://www.i18next.com/) æ˜¯ä¸€ä¸ª JavaScript å›½é™…åŒ–æ¡†æ¶ï¼Œåœ¨ ReactLynx ä¸­ä½¿ç”¨å®ƒæœ‰ä»¥ä¸‹ä¼˜ç‚¹ï¼š

1. **ç®€æ´**ï¼š`i18next` æä¾›äº†ç®€å•æ˜“ç”¨çš„ APIï¼Œè®©åœ¨ ReactLynx ä¸­å®ç°å›½é™…åŒ–å˜å¾—æ›´åŠ ç®€å•
2. **æŒ‰éœ€åŠ è½½**ï¼šæ”¯æŒæŒ‰éœ€åŠ è½½è¯­è¨€èµ„æºï¼Œå‡å°‘é¦–å±åŠ è½½æ—¶é—´
3. **å¹¿æ³›æ”¯æŒ**ï¼šå…¼å®¹å¤šç§æ ¼å¼å’Œåç«¯ï¼Œå…è®¸ä¸ä¸åŒçš„ç¿»è¯‘å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼ˆå¦‚ JSON æ–‡ä»¶ã€è¿œç¨‹ API ç­‰ï¼‰è½»æ¾é›†æˆã€‚
4. **æ”¯æŒç¼“å­˜**ï¼šå†…ç½®ç¼“å­˜æœºåˆ¶åŠ å¿«è¯­è¨€èµ„æºçš„åŠ è½½é€Ÿåº¦ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚
5. **ä¸°å¯Œçš„ç¤¾åŒºæ”¯æŒ**ï¼šæ‹¥æœ‰åºå¤§çš„ç¤¾åŒºå’Œä¸°å¯Œçš„æ’ä»¶ï¼Œæ»¡è¶³å¤šæ ·åŒ–çš„å›½é™…åŒ–éœ€æ±‚ã€‚
6. **å¯é æ€§**ï¼šåœ¨ä¼—å¤šé¡¹ç›®ä¸­å¾—åˆ°éªŒè¯ï¼Œæä¾›ç¨³å®šæ€§å’Œå¯é æ€§ã€‚
7. **çƒ­é‡è½½**ï¼šè¯­è¨€èµ„æºçš„æ›´æ”¹å¯ä»¥ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡æ–°å‘å¸ƒåº”ç”¨ã€‚

### å®‰è£…

ä½ éœ€è¦å®‰è£… `i18next` ä½œä¸ºä¾èµ–ï¼š

<PackageManagerTabs command="install i18next@^23.16.8" />

:::tip
[`i18next@24.0.0+`](https://www.i18next.com/misc/migration-guide#v23.x.x-to-v24.0.0) ç‰ˆæœ¬è¦æ±‚è¿è¡Œç¯å¢ƒå¿…é¡»èƒ½å¤Ÿä½¿ç”¨ [`Intl.pluralRules`](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Intl/PluralRules) APIï¼Œä½†æ˜¯ç›®å‰ Lynx å½“ä¸­å°šæœªå®ç°è¯¥ APIï¼Œå› æ­¤éœ€è¦ï¼š

1. ä½¿ç”¨ v23 å¹¶ä¸”å¯ç”¨ [`compatibilityJSON: 'v3'`](https://www.i18next.com/misc/json-format#i18next-json-v3) é€‰é¡¹
2. ä½¿ç”¨ v24 å¹¶ä¸”å¯¹ `Intl.PluralRules` API è¿›è¡Œ [polyfill](https://github.com/eemeli/intl-pluralrules)

:::

### åˆ›å»ºç¬¬ä¸€ä¸ªæ–‡æ¡ˆç¿»è¯‘

å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹çš„æ–‡æ¡ˆèµ„æºï¼š

```json title="src/locales/en.json"
{
  "world": "World"
}
```

åˆ›å»ºç¿»è¯‘å‡½æ•°åªéœ€è¦ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š

1. å¼•å…¥æ–‡æ¡ˆèµ„æº `./locales/en.json`
2. ä½¿ç”¨ [`createInstance()`](https://www.i18next.com/overview/api#createinstance) å‡½æ•°åˆ›å»º `i18next` å®ä¾‹
3. ç”¨å¼•å…¥çš„æ–‡æ¡ˆèµ„æº[åˆå§‹åŒ–](https://www.i18next.com/overview/api#init) i18n å®ä¾‹

```typescript title="src/i18n.ts"
import i18next from 'i18next';
import type { i18n } from 'i18next';

import enTranslation from './locales/en.json';

const localI18nInstance: i18n = i18next.createInstance();

localI18nInstance.init({
  lng: 'en',
  // The default JSON format needs `Intl.PluralRules` API, which is currently unavailable in Lynx.
  compatibilityJSON: 'v3',
  resources: {
    en: {
      translation: enTranslation, // `translation` is the default namespace
    },
  },
});

export { localI18nInstance as i18n };
```

:::tip

å¦‚æœä½ åœ¨ TypeScript æ–‡ä»¶ä¸­å¼•å…¥ `*.json`, ä½ éœ€è¦åœ¨ `tsconfig.json` æ–‡ä»¶ä¸­è®¾ç½® `compilerOptions.resolveJsonModule` é€‰é¡¹ä¸º `true`ã€‚

```json title="tsconfig.json"
{
  "compilerOptions": {
    "resolveJsonModule": true
  }
}
```

:::

æ¥ä¸‹æ¥ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `i18n.t` å‡½æ•°æ¥è¿›è¡Œæ–‡æ¡ˆç¿»è¯‘ï¼š

```tsx title="src/App.tsx" {3,12}
import { useEffect } from '@lynx-js/react';

import { i18n } from './i18n.js';

export function App() {
  useEffect(() => {
    console.log(`Hello, ReactLynx x i18next!`);
  }, []);

  return (
    <view>
      <text>Hello, {i18n.t('world')}</text>
    </view>
  );
}
```

### åŒæ­¥åŠ è½½æ–‡æ¡ˆèµ„æº

åœ¨çœŸå®çš„é¡¹ç›®ä¸­ï¼Œé€šå¸¸æœ‰å¤šä¸ªä¸åŒè¯­è¨€çš„æ–‡æ¡ˆèµ„æºã€‚

ä½ å¯ä»¥ä½¿ç”¨ [`import.meta.webpackContext`](https://rspack.dev/api/runtime-api/module-variables#importmetawebpackcontext) API æ¥ä¸€æ¬¡æ€§å°†ä»–ä»¬å…¨éƒ¨å¼•å…¥ï¼š

<Columns titles={['import one-by-one', 'import.meta.webpackContext']}>

```js
// Static-imported locales that can be shown at first screen
import enTranslation from './locales/en.json';
import zhTranslation from './locales/zh.json';
import itTranslation from './locales/it.json';
import jpTranslation from './locales/jp.json';
import deTranslation from './locales/de.json';
import esTranslation from './locales/es.json';
import frTranslation from './locales/fr.json';
import idTranslation from './locales/id.json';
import ptTranslation from './locales/pt.json';
```

```js
const localesContext = import.meta.webpackContext('./locales', {
  recursive: false,
  regExp: /\.json$/,
});
const enTranslation = localesContext('en.json');
```

</Columns>

è¿™äº›èµ„æºä¹Ÿå¯ä»¥è¢«æ·»åŠ åˆ° `i18next.init()` ä¸­æ¥è®©é¦–å±æ¸²æŸ“ä¸­çš„æ–‡æ¡ˆå¾—åˆ°ç¿»è¯‘ï¼š

```typescript title="src/i18n.ts"
import i18next from 'i18next';
import type { i18n } from 'i18next';

// Localizations imported statically, available at the initial screen
const localesContext = import.meta.webpackContext('./locales', {
  recursive: false,
  regExp: /\.json$/,
});

const localI18nInstance: i18n = i18next.createInstance();

localI18nInstance.init({
  lng: 'en',
  // The default JSON format needs Intl.PluralRules API, which is currently unavailable in Lynx.
  compatibilityJSON: 'v3',
  // Add all statically imported localizations to i18next resources.
  resources: Object.fromEntries(
    localesContext.keys().map((key) => [
      key.match(/\/([^/]+)\.json$/)?.[1] || key,
      {
        translation: localesContext(key) as Record<string, string>,
      },
    ]),
  ),
});

export { localI18nInstance as i18n };
```

:::tip
ä½ å¯ä»¥éœ€è¦ [Rspeedy Type Declaration](guide/typescript.md#rspeedy-type-declaration) æ¥è·å¾— `import.meta.webpackContext` çš„ TypeScript ç±»å‹å®šä¹‰
:::

### å¼‚æ­¥æŒ‰éœ€åŠ è½½æ–‡æ¡ˆèµ„æº

åŒæ­¥åŠ è½½èµ„æºä¼šä½¿å¾—å…¨éƒ¨çš„æ–‡æ¡ˆèµ„æºéƒ½æ‰“åŒ…åœ¨äº§ç‰©ä¸­ï¼Œå¯¼è‡´é¦–å±åŠ è½½æ€§èƒ½è¾ƒå·®ã€‚
æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ `import()` æ¥å¼‚æ­¥ã€æŒ‰éœ€å¼•å…¥æ–‡æ¡ˆèµ„æºã€‚

é¦–å…ˆéœ€è¦å®‰è£… [`i18next-resources-to-backend`](https://github.com/i18next/i18next-resources-to-backend) ä½œä¸ºä¾èµ–ï¼š

<PackageManagerTabs command="install i18next-resources-to-backend" />

æ¥ä¸‹æ¥åœ¨ `src/i18n.ts` ä¸­æ·»åŠ ä¸‹é¢çš„ä»£ç ï¼š

```typescript title="src/i18n.ts" {3,14-23,38}
import i18next from 'i18next';
import type { i18n } from 'i18next';
import resourcesToBackend from 'i18next-resources-to-backend';

// Localizations imported statically, available at the initial screen
const localesContext = import.meta.webpackContext('./locales', {
  recursive: false,
  regExp: /(en|zh)\.json$/,
});

const localI18nInstance: i18n = i18next.createInstance();

// We can only loading resources on a background thread
if (__JS__) {
  localI18nInstance.use(
    // See: https://www.i18next.com/how-to/add-or-load-translations#lazy-load-in-memory-translations
    resourcesToBackend(
      (language: string) =>
        // Dynamic-imported locales can be used with `i18n.loadLanguages`
        import(`./locales/${language}.json`),
    ),
  );
}

localI18nInstance.init({
  lng: 'en',
  // The default JSON format needs Intl.PluralRules API, which is currently unavailable in Lynx.
  compatibilityJSON: 'v3',
  // Add all statically imported localizations to i18next resources.
  resources: Object.fromEntries(
    localesContext.keys().map((key) => [
      key.match(/\/([^/]+)\.json$/)?.[1] || key,
      {
        translation: localesContext(key) as Record<string, string>,
      },
    ]),
  ),
  partialBundledLanguages: true,
});

export { localI18nInstance as i18n };
```

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­

1. ä¸€ä¸ª `i18next` çš„ä¸­é—´ä»¶ `i18next-resources-to-backend` åœ¨åå°çº¿ç¨‹ä¸­è¢«æ·»åŠ åˆ° `localI18nInstance.use` å½“ä¸­
2. æ–‡æ¡ˆèµ„æºå¯ä»¥è¢«å¼‚æ­¥æŒ‰éœ€åŠ è½½ï¼ˆå…¶ä¸­çš„éƒ¨åˆ†ï¼Œå¦‚ `zh`, `en` ä¾ç„¶åŒæ­¥åŠ è½½ï¼‰

åœ¨äº§ç‰©ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆäº†å¤šä¸ª JavaScript æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«äº†æ–‡æ¡ˆèµ„æºï¼š

<Columns>

```js title=src_locales_it-IT_json.js
'use strict';
exports.ids = ['src_locales_it-IT_json'];
exports.modules = {
  './src/locales/it-IT.json': function (module) {
    module.exports = JSON.parse('{"world": "Mondo"}');
  },
};
```

```js title=src_locales_ja-JP_json.js
'use strict';
exports.ids = ['src_locales_ja-JP_json'];
exports.modules = {
  './src/locales/ja-JP.json': function (module) {
    module.exports = JSON.parse('{"world": "ä¸–ç•Œ"}');
  },
};
```

</Columns>

ä½ å¯èƒ½è¿˜ä¼šæ³¨æ„åˆ°è¿™ä¸¤ä¸ªæ²¡æœ‰è¢«åŠ è½½ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒè¢«ç§°ä¸ºæŒ‰éœ€åŠ è½½ï¼Œå¯¹èµ„æºçš„è¯·æ±‚ä»…åœ¨éœ€è¦æ—¶æ‰ä¼šå‘é€ã€‚

:::tip title=ğŸ’¡ ä¸ºä»€ä¹ˆæ²¡æœ‰ä¸º src/locales/en.json ç”Ÿæˆå•ç‹¬çš„ JavaScript æ–‡ä»¶ï¼Ÿ
è¿™æ˜¯å› ä¸ºè¯¥æ¨¡å—å·²ç»åŒ…å«åœ¨ä¸»äº§ç‰©ä¸­ï¼ŒWebpack/Rspack ä¼šè‡ªåŠ¨å°†å…¶ç§»é™¤ã€‚

è¯·å‚è§ [optimization.removeAvailableModules](https://webpack.js.org/configuration/optimization/#optimizationremoveavailablemodules) å’Œ [optimization.removeEmptyChunks](https://webpack.js.org/configuration/optimization/#optimizationremoveemptychunks)ã€‚

:::

### åˆ‡æ¢è¯­è¨€

è°ƒç”¨ `i18next.changeLanguage` API å¯ä»¥åœ¨ä¸åŒè¯­è¨€é—´è¿›è¡Œåˆ‡æ¢ï¼š

```jsx title="src/App.tsx"
import { useEffect, useState } from '@lynx-js/react';

import { i18n } from './i18n.js';

export function App() {
  const [locale, setLocale] = useState('en');

  useEffect(() => {
    console.log('Hello, ReactLynx3 x i18next!');
  }, []);

  const getNextLocale = (locale: string) => {
    // mock locales
    const locales = ["en", "zh-CN"];
    const index = locales.indexOf(locale);
    return locales[(index + 1) % locales.length];
  };

  return (
    <view>
      <text style={{ color: 'red' }}>Current locale: {locale}</text>
      <text
        bindtap={async () => {
          const nextLocale = getNextLocale(locale);
          await i18n.changeLanguage(nextLocale);
          setLocale(nextLocale);
        }}
      >
        Tap to change locale
      </text>
      <text>Hello, {i18n.t('world')}</text>
    </view>
  );
}
```
